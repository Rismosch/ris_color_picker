<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ris_color_picker</title>
    <style>
        :root{
            --pico-8-black:         #000000;
            --pico-8-blue:          #1d2b53;
            --pico-8-purple:        #7e2553;
            --pico-8-green:         #008751;
            --pico-8-brown:         #ab5236;
            --pico-8-dark-grey:     #5f574f;
            --pico-8-light-grey:    #c2c3c7;
            --pico-8-white:         #fff1e8;
            --pico-8-red:           #ff004d;
            --pico-8-orange:        #ffa300;
            --pico-8-yellow:        #ffec27;
            --pico-8-lime:          #00e436;
            --pico-8-cyan:          #29adff;
            --pico-8-washed-grey:   #83769c;
            --pico-8-pink:          #ff77a8;
            --pico-8-flesh:         #ffccaa;
        }

        .canvas {
            border: 1px solid var(--pico-8-dark-grey);
        }

        .centered {
            display: flex;
            align-items: center;
            margin: 5px;
        }

        .label {
            width: 10px;
            margin: 0px 0px 0px 5px;
            user-select: none;
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* Internet Explorer/Edge */
        }

        .slider {
            margin: 0px 10px 0px 10px;
        }

        .text_field {
            width: 75px;
        }

    </style>
</head>
<body style="background: var(--pico-8-white); font-family: Arial, sans-serif;">
    <div id="javascript_content" style="display: none">
        <!--canvas-->
        <table style="display: inline-block">
            <tr>
                <td><canvas id="canvas_xy" class="canvas" width="256" height="256"></canvas></td>
                <td><canvas id="canvas_z" class="canvas" width="20" height="256"></canvas></td>
            </tr>
        </table>

        <!--sliders-->
        <table style="display: inline-block">
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td>
                    <select id="format_dropdown" class="text_field">
                        <option value="normalized">0..1</option>
                        <option value="byte">0..255</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><input type="radio" id="radio_r" name="z_coord"></td>
                <td><span class="label" title="Red">R</span></td>
                <td><input type="range" id="slider_r" class="slider" min="0" max="255" step="1"></td>
                <td>
                    <input type="number" id="byte_field_r" class="text_field" min="0" max="255" step="1">
                    <input type="number" id="normalized_field_r" class="text_field" min="0" max="1" step="0.003">
                </td>
            </tr>
            <tr>
                <td><input type="radio" id="radio_g" name="z_coord"></td>
                <td><span class="label" title="Green">G</span></td>
                <td><input type="range" id="slider_g" class="slider" min="0" max="255" step="1"></td>
                <td>
                    <input type="number" id="byte_field_g" class="text_field" min="0" max="255">
                    <input type="number" id="normalized_field_g" class="text_field" min="0" max="1" step="0.003">
                </td>
            </tr>
            <tr>
                <td><input type="radio" id="radio_b" name="z_coord"></td>
                <td><span class="label" title="Blue">B</span></td>
                <td><input type="range" id="slider_b" class="slider" min="0" max="255" step="1"></td>
                <td>
                    <input type="number" id="byte_field_b" class="text_field" min="0" max="255">
                    <input type="number" id="normalized_field_b" class="text_field" min="0" max="1" step="0.003">
                </td>
            </tr>
            <tr>
                <td><input type="radio" id="radio_l" name="z_coord"></td>
                <td><span class="label" title="OkLab Luminocity">L</span></td>
                <td><input type="range" id="slider_l" class="slider" min="0" max="255" step="1"></td>
                <td>
                    <input type="number" id="byte_field_l" class="text_field" min="0" max="255">
                    <input type="number" id="normalized_field_l" class="text_field" min="0" max="1" step="0.003">
                </td>
            </tr>
            <tr>
                <td><input type="radio" id="radio_c" name="z_coord"></td>
                <td><span class="label" title="OkLab Chroma">C</span></td>
                <td><input type="range" id="slider_c" class="slider" min="0" max="255" step="1"></td>
                <td>
                    <input type="number" id="byte_field_c" class="text_field" min="0" max="255">
                    <input type="number" id="normalized_field_c" class="text_field" min="0" max="1" step="0.003">
                </td>
            </tr>
            <tr>
                <td><input type="radio" id="radio_h" name="z_coord" checked="checked"></td>
                <td><span class="label" title="OkLab Hue">H</span></td>
                <td><input type="range" id="slider_h" class="slider" min="0" max="255" step="1"></td>
                <td>
                    <input type="number" id="byte_field_h" class="text_field" min="0" max="255">
                    <input type="number" id="normalized_field_h" class="text_field" min="0" max="1" step="0.003">
                </td>
            </tr>
            <tr>
                <td></td>
                <td colspan="2"><span class="label">Hex Code</span></td>
                <td><input type="text" id="hex_field" class="text_field"></td>
            </tr>
        </table>

        <!--interpolation-->
        <button onclick="clear_cookie()">Reset</Button>

    </div>
    <noscript>
        <p>You need to enable JavaScript for this page to work &#9757;&#129299;</p>
    </noscript>
    <script>
        // enable color picker
        document.getElementById("javascript_content").style.display = "inline";

        // get elements
        const canvas_xy = document.getElementById("canvas_xy");
        const canvas_z = document.getElementById("canvas_z");
        const ctx_xy = canvas_xy.getContext('2d');
        const ctx_z = canvas_z.getContext('2d');
        const format_dropdown = document.getElementById("format_dropdown");
        const byte_field_r = document.getElementById("byte_field_r");
        const byte_field_g = document.getElementById("byte_field_g");
        const byte_field_b = document.getElementById("byte_field_b");
        const byte_field_l = document.getElementById("byte_field_l");
        const byte_field_c = document.getElementById("byte_field_c");
        const byte_field_h = document.getElementById("byte_field_h");
        const normalized_field_r = document.getElementById("normalized_field_r");
        const normalized_field_g = document.getElementById("normalized_field_g");
        const normalized_field_b = document.getElementById("normalized_field_b");
        const normalized_field_l = document.getElementById("normalized_field_l");
        const normalized_field_c = document.getElementById("normalized_field_c");
        const normalized_field_h = document.getElementById("normalized_field_h");

        // initialize format_dropdown
        format_dropdown.addEventListener("change", format_dropdown_change_callback);

        // read cookie
        const cookie_name = "ris_color_picker_cookie";
        let cookie;
        read_cookie();

        update_canvas();
        format_dropdown_change_callback();

        // callbacks
        function format_dropdown_change_callback() {
            const selected_value = this.value;
            const show_byte_field = selected_value === "byte";
            const byte_display = show_byte_field ? "block" : "none";
            const normalized_display = show_byte_field ? "none" : "block";
            byte_field_r.style.display = byte_display;
            byte_field_g.style.display = byte_display;
            byte_field_b.style.display = byte_display;
            byte_field_l.style.display = byte_display;
            byte_field_c.style.display = byte_display;
            byte_field_h.style.display = byte_display;
            normalized_field_r.style.display = normalized_display;
            normalized_field_g.style.display = normalized_display;
            normalized_field_b.style.display = normalized_display;
            normalized_field_l.style.display = normalized_display;
            normalized_field_c.style.display = normalized_display;
            normalized_field_h.style.display = normalized_display;
        }

        // canvas functions
        function update_canvas() {
            update_canvas_xy();
            update_canvas_z();
        }

        function update_canvas_xy() {
            const width = canvas_xy.width;
            const height = canvas_xy.height;

            const imageData = ctx_xy.createImageData(width, height);
            const data = imageData.data;

            for (let y = 0; y <= height; ++y) {
                for (let x = 0; x < width; ++x) {
                    const inverted_y = height - y;
                    const i = (inverted_y * width + x) * 4; // each pixel has 4 values: r, g, b, a

                    const normalized_x = x / width;
                    const normalized_y = y / height;

                    data[i + 0] = 255 * normalized_x;
                    data[i + 1] = 255 * normalized_y;
                    data[i + 2] = 0;
                    data[i + 3] = 255;
                }
            }

            ctx_xy.putImageData(imageData, 0, 0);
        }

        function update_canvas_z() {
            const width = canvas_z.width;
            const height = canvas_z.height;

            const imageData = ctx_z.createImageData(width, height);
            const data = imageData.data;

            for (let y = 0; y <= height; ++y) {
                for (let x = 0; x < width; ++x) {
                    const inverted_y = height - y;
                    const i = (inverted_y * width + x) * 4; // each pixel has 4 values: r, g, b, a

                    const normalized_y = y / height;

                    data[i + 0] = 0;
                    data[i + 1] = 0;
                    data[i + 2] = 255 * normalized_y;
                    data[i + 3] = 255;
                }
            }

            ctx_z.putImageData(imageData, 0, 0);
        }

        // cookie functions
        function read_cookie() {
            let cookie_exists = false;
            const cookies = document.cookie.split("; ");
            for (let c of cookies) {
                const [key, value] = c.split("=");
                if (key === cookie_name) {
                    try {
                        console.log("cookie exists! parsing...")
                        cookie = JSON.parse(value);
                        cookie_exists = true;
                    } catch (e) {
                        console.log(`failed to parse cookie: ${e}`)
                    }

                    break;
                }
            }

            if (!cookie_exists) {
                console.log("failed to find valid cookie. creating a new one...")

                cookie = {
                    selected_z: "r", // r, g, b, l, c, h,
                    format_field: "normalized", // "normalized", "byte",
                }
            }

            const cookie_string = JSON.stringify(cookie);
            console.log(`loaded cookie: ${cookie_string}`);
        }

        function save_cookie() {
            // get expiration date 1 week from now
            const date = new Date();
            date.setDate(date.getDate() + 7);
            const expiration_date = date.toUTCString();

            console.log(cookie);

            const cookie_data = JSON.stringify(cookie);

            console.log("setting cookie...");
            document.cookie = `${cookie_name}=${cookie_data}; path=/; expires=${expiration_date}`
            console.log("set cookie: " + document.cookie);
        }

        function clear_cookie() {
            document.cookie = `${cookie_name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
            console.log("cleared cookie");
        }
    </script>
</body>
</html>
